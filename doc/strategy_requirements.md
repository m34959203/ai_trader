# Требования к базовой торговой стратегии

Документ фиксирует минимальный набор требований к стратегии AI-трейдера, который используется на этапе подготовки инфраструктуры. Он служит «контрактом» между командой разработки и операционной командой и позволяет быстро проверить готовность сервиса перед переходом к следующему этапу.

## 1. Рынок и канал исполнения
- **Биржа:** Binance Spot, тестовая среда (testnet) используется по умолчанию в конфигурации исполняющего сервиса. 【F:configs/exec.yaml†L1-L16】【F:tasks/auto_trader.py†L65-L82】
- **Торгуемые инструменты:** стартовый список включает `BTCUSDT`; допускается расширение списка через переменные окружения `AUTO_TRADER_SYMBOLS`. 【F:tasks/auto_trader.py†L45-L83】
- **Канал исполнения:** REST API приложения FastAPI (`/trading`, `/exec`) и внутренний исполнитель `auto_trader` (polling раз в 30 секунд, HTTP таймаут 20 сек). 【F:tasks/auto_trader.py†L45-L120】
- **Резервный канал:** ручной запуск сделок через REST-эндпойнты `/exec/order` с теми же ключами API.

## 2. Источники данных и требования к котировкам
- **Источники:** хранение исторических свечей в Postgres/Timescale через сервис `ohlcv_loader`; оперативные данные приходят через Binance WebSocket (интервалы `1m`, `5m`) и REST-backfill на 1 000 баров. 【F:src/main.py†L238-L352】
- **Необходимый минимум истории:** не менее `max(fast, slow) + 5` баров на каждый актив и таймфрейм, что проверяется при расчёте сигналов. 【F:routers/trading.py†L64-L90】
- **Валидация данных:** все свечи проходят проверку на полноту и дубликаты (см. `routers/trading._rows_to_df`). 【F:routers/trading.py†L23-L62】

## 3. Торговая логика
- **Базовая стратегия:** пересечение скользящих средних (EMA) с антишумовыми фильтрами.
  - Быстрая EMA (`fast`) = 20, медленная EMA (`slow`) = 50 по умолчанию. 【F:tasks/auto_trader.py†L57-L120】【F:src/strategy.py†L120-L196】
  - Дополнительные фильтры: `persist` (подтверждение сигнала), `cooldown` (заморозка после сделки), минимальный процентный зазор между EMA, опциональный фильтр режима рынка по волатильности. 【F:src/strategy.py†L120-L214】
- **Формирование сигналов:** `auto_trader` получает последние N свечей через REST, пересчитывает сигналы локально и принимает решение об открытии/закрытии позиций. 【F:tasks/auto_trader.py†L260-L344】
- **Стопы и тейки:** ATR-ориентированный стоп (`atr_period = 14`, `atr_mult = 2.0`) с ограничениями `min_sl_pct`/`max_sl_pct`; тейк-профит задаётся через `AUTO_TRADER_TP_PCT`. 【F:tasks/auto_trader.py†L49-L120】【F:tasks/auto_trader.py†L310-L341】
- **Аварийный выход:** при сигнале «смертельного креста» (`sell_on_death = True`) вся позиция закрывается. 【F:tasks/auto_trader.py†L101-L118】

## 4. Управление рисками
- **Риск на сделку:** целевой процент капитала на сделку берётся из `risk.yaml` (`risk_pct_per_trade`), допускается автоподбор размера позиции (`use_risk_autosize = True`). 【F:configs/risk.yaml†L1-L6】【F:tasks/auto_trader.py†L101-L120】
- **Ограничение дневных потерь:** `daily_max_loss_pct` и `max_trades_per_day` из конфигурации риска должны учитываться оркестратором (проверяется при бэктестах и работе `deadman`). 【F:configs/risk.yaml†L1-L6】【F:services/selfcheck.py†L31-L53】
- **Контроль портфельного риска:** опция `use_portfolio_risk` с лимитом `max_portfolio_risk`; для каждой позиции считается доля капитала под риском. 【F:tasks/auto_trader.py†L101-L213】
- **Deadman/heartbeat:** приложение обязано обновлять файл `data/state/heartbeat.txt`; при зависании сверх `deadman_max_stale_sec` супервизор должен перезапустить сервис. 【F:src/main.py†L212-L290】

## 5. Операционные требования
- **Метрики готовности:** сервис предоставляет эндпойнты `/health`, `/_livez`, `/_readyz`, а также расширенный self-check с проверкой Binance, базы данных и ресурсов. 【F:src/main.py†L602-L708】【F:services/selfcheck.py†L10-L55】
- **Мониторинг ресурсов:** включён асинхронный монитор (CPU, RAM, RSS процесса, занятость диска) с оповещениями и опциональным аварийным рестартом. Подробности описаны в `doc/system_monitoring.md`. 【F:monitoring/resource_monitor.py†L1-L236】
- **Алёрты:** уведомления отправляются в Telegram/SMTP с троттлингом и ретраями; конфигурация каналов хранится в `configs/exec.yaml` или переменных окружения. 【F:monitoring/alerts.py†L18-L210】

## 6. Чеклист внедрения
1. Настроить ключи API Binance (testnet) и убедиться, что `auto_trader` видит баланс счёта не ниже `equity_min_usdt`.
2. Загрузить историю для целевых инструментов (минимум `max(fast, slow)+5` баров) и проверить корректность через `/ohlcv/prices/query`.
3. Прогнать self-check и убедиться в отсутствии ошибок (`db`, `quotes`, `resources` → ok).
4. Запустить `auto_trader` в режиме `dry_run=False` и убедиться, что создаётся heartbeat и журнал сделок.
5. Проверить, что мониторинг ресурсов отправляет heartbeat и реагирует на искусственно повышенную нагрузку.

Документ должен обновляться при изменении торговой логики, параметров риска или подключении новых рынков.
