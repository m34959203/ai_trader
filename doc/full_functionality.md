# Полный функционал AI Trader

## 1. Этапы и статус доставки
Платформа развивается по четырём этапам, каждый из которых закрывает отдельный слой зрелости. Stage 1 завершил построение базы данных OHLCV, API для загрузки/экспорта и health-check’ов, которые служат фундаментом остальных сервисов.【F:doc/project_overview.md†L3-L7】【F:doc/stage1_status.md†L1-L21】 Stage 2 добавил расширенную аналитику: библиотеку индикаторов, sentiment-aware анализ, планировщик новостей и валидируемые ансамбли стратегий с прописанными зависимостями.【F:doc/project_overview.md†L9-L19】【F:doc/stage2_status.md†L3-L17】 Stage 3 довёл до продакшен-уровня бумажный трейдинг, автоисцеление, риск-контроль и наблюдаемость, дополнив их операционными runbook’ами.【F:doc/project_overview.md†L21-L29】【F:doc/stage3_status.md†L3-L23】 Stage 4 вывел систему в режим живой торговли: брокерские интеграции, комплаенс, SLO-мониторинг, ML-операции и операторский интерфейс переведены в стадию 100 % готовности.【F:doc/project_overview.md†L5-L7】【F:doc/stage4_status.md†L1-L38】

## 2. Платформа данных и API (Stage 1)
- **Единая витрина OHLCV.** ORM-модель и CRUD обеспечивают идемпотентные upsert’ы и нормализацию котировок, что позволяет безопасно переигрывать загрузки и поддерживать индексы для аналитики.【F:doc/stage1_status.md†L6-L13】  
- **Публичные эндпоинты.** REST-интерфейсы `/prices/store`, `/ohlcv`, `/ohlcv.csv` дают потоковые выгрузки и пагинацию, а жизненно важные health-пробы стандартизированы под эксплуатационные контуры.【F:doc/stage1_status.md†L11-L16】  
- **Автотесты.** Интеграционные сценарии покрывают ingestion, экспорт и отказоустойчивость API, предотвращая регрессии базового слоя данных.【F:doc/stage1_status.md†L17-L21】

## 3. Аналитика рынка и стратегии (Stage 2)
- **Библиотека индикаторов.** Файл `src/indicators.py` реализует широкий набор осцилляторов, объёмных и свечных индикаторов с обработкой коротких историй, а тесты гарантируют корректность формул.【F:doc/project_overview.md†L10-L19】【F:doc/stage2_status.md†L6-L8】  
- **Sentiment-aware анализ.** `analyze_market` объединяет технические сигналы с новостной чувствительностью, формируя итоговый скоринг и диагностический трейс для оркестратора стратегий.【F:doc/project_overview.md†L10-L19】【F:doc/stage2_status.md†L6-L9】  
- **Пайплайн новостей.** Асинхронный воркер опрашивает RSS, дедуплицирует и кеширует заголовки, автоматически поднимаясь при старте FastAPI.【F:doc/project_overview.md†L14-L15】【F:doc/stage2_status.md†L6-L10】  
- **Ансамбли стратегий.** Pydantic-схемы и конфигурации проверяют веса, частоту и названия стратегий ещё до исполнения, а тесты предотвращают некорректные конфиги.【F:doc/project_overview.md†L16-L19】【F:doc/stage2_status.md†L6-L11】

## 4. Торговый движок, симуляция и риск (Stage 3)
- **Paper-трейдинг.** Эндпоинты `/paper/backtest` и движок `src/paper.py` ведут детальный журнал с комиссиями, SL/TP, трейлингом и equity-кривыми для пост-мортем анализа.【F:doc/project_overview.md†L21-L24】【F:doc/stage3_status.md†L5-L9】  
- **Риск и автоисцеление.** `services/trading_service.py` обеспечивает лимиты на сделку/день, портфельные ограничения и интеграцию с автоисцелением, которое сохраняет снапшоты исполнителей и восстанавливает их при сбоях.【F:doc/project_overview.md†L22-L29】【F:doc/stage3_status.md†L10-L18】  
- **Реконсиляция и брокерские абстракции.** Реестр брокеров включает симулятор и Binance, а сервис сверяет журналы с биржей и компенсирует расхождения автоматически.【F:doc/project_overview.md†L24-L29】【F:doc/stage3_status.md†L10-L18】  
- **Операционные руководства.** Runbook’и описывают новости, автоисцеление, Prometheus и бумажные циклы, помогая поддерживать Stage 3 в 24/7 режиме.【F:doc/project_overview.md†L38-L42】【F:doc/stage3_status.md†L15-L21】

## 5. Живая торговля и эксплуатация (Stage 4)
- **Брокерская интеграция.** `BinanceBrokerGateway` реализует полный цикл заявок, а `LiveTradingCoordinator` ведёт аудит, повторяет попытки и синхронизирует состояние с биржей, предоставляя единый API `/live` для операторов и автоматизации.【F:doc/stage4_status.md†L10-L18】  
- **Комплаенс и безопасность.** Предторговые проверки, WORM-журнал и runbook’и по KYC/AML и CAB обеспечивают соответствие регуляторным требованиям.【F:doc/stage4_status.md†L16-L20】  
- **Наблюдаемость.** Prometheus-гистограммы и runbook’и по Kubernetes/Terraform покрывают latency, доступность потоков и алертинг (Slack/PagerDuty).【F:doc/stage4_status.md†L21-L24】  
- **ML-операции.** FinBERT с кешем и валидацией, роутер моделей с ADWIN и CLI для meta-label обучения формируют полный MLOps-контур.【F:doc/stage4_status.md†L25-L29】  
- **Готовность к эксплуатации.** Чек-листы live-trading и операционные процедуры подтверждают 100 % готовность Stage 4.【F:doc/stage4_status.md†L30-L38】

## 6. Операторский dashboard (UI) — ключевой центр управления
### 6.1. Архитектура и доступность
Панель `/ui` построена на Tailwind и HTMX, включает адаптивный layout, индикатор загрузки и переключатель темы, сохраняя пользовательские настройки в `localStorage`. Контролы (режим исполнения, тестнет, интервалы опроса) передаются во все partial-запросы через HTMX, обеспечивая консистентность данных на каждой карточке.【F:templates/monitor/index.html†L1-L200】【F:templates/monitor/index.html†L233-L386】

### 6.2. Карточки мониторинга
- **Баланс.** Показывает биржу, флаг TESTNET, equity, fallback-агрегацию по стейблам и актуальные риск-лимиты, а также таблицу активов с сортировкой по объёму.【F:templates/monitor/_balance.html†L1-L118】  
- **Позиции.** Нормализует поля разных провайдеров, выделяет сторону цветом и подсвечивает текущий UPnL для диагностики позиций.【F:templates/monitor/_positions.html†L1-L86】  
- **Ордера.** Унифицирует поля времени, стороны, объёма и статуса, автоматически подбирая бейджи для прогресса исполнения.【F:templates/monitor/_orders.html†L1-L89】  
- **Live PnL.** Отображает старт equity, текущее значение, реализованный результат, просадку и счётчик сделок дня.【F:templates/monitor/_live_pnl.html†L1-L34】  
- **Статус брокера.** Визуализирует соединение, количество активных ордеров/позиций, последнюю ошибку и табличный срез заявок, позиций и балансов брокера.【F:templates/monitor/_broker_status.html†L1-L86】  
- **Live сделки.** Даёт журнал последних исполнений с выделением стороны, статуса и идентификаторов заявок, плюс кнопку ручного обновления панели.【F:templates/monitor/_live_trades.html†L1-L43】  
- **Метрики рынка.** Рассчитывает Sharpe и годовую волатильность, автоматически классифицируя значения по порогам и выводя параметры окна/annualization.【F:templates/monitor/_metrics.html†L1-L73】  
- **Лимиты и отчёты.** Сводка дневных лимитов, список стратегий с inline-редактированием и скачивание CSV/PDF отчётов через UI-кнопки.【F:templates/monitor/_limits.html†L1-L98】

### 6.3. UX-механики и защита от ошибок
Интерфейс снабжён всплывающими подсказками, тостами об ошибках HTMX, глобальным уведомлением об офлайн-состоянии и программным переключателем интервалов опроса для всех секций, что повышает устойчивость панели к сетевым сбоям и снижает нагрузку на API.【F:templates/monitor/index.html†L229-L386】

### 6.4. Управление стратегиями и отчётностью
Из карточки «Риск-лимиты и стратегии» можно включать/отключать стратегии, задавать лимит риска и дневное количество сделок, а обновлённые настройки отправляются в `/live/strategies/{name}` с визуальным подтверждением. Кнопка «Пересоздать отчёты» дергает `POST /reports/generate`, после чего доступны ссылки на свежие CSV/PDF с размерами файлов.【F:templates/monitor/index.html†L339-L381】【F:templates/monitor/_limits.html†L1-L98】

### 6.5. Операционный контекст
Runbook предписывает держать панель открытой во время сессии, пользоваться переключателями режима/testnet, мониторить дневные guardrails и уведомления, а также дергать генерацию отчётов или выключать стратегии при превышении лимитов; список алертов включает обрыв брокера, дневную просадку, автоблокировки стратегий и сбои отчётных задач.【F:doc/runbooks.md†L97-L146】

## 7. Наблюдаемость, runbook’и и эксплуатация
Observability-хаб публикует метрики для Prometheus и SLO API, а runbook’и описывают запуск/отладку воркеров новостей, автоисцеление, мониторинг, процедуру комплаенса и развёртывание в Kubernetes с алертингом Slack/PagerDuty и лог-шиппингом.【F:doc/project_overview.md†L38-L42】【F:doc/runbooks.md†L1-L120】【F:monitoring/observability.py†L22-L95】

## 8. API и фоновые сервисы
FastAPI-приложение монтирует модули цен, трейдинга, исполнения, autopilot, UI и мониторинга, а старт/остановка сервиса поднимает или гасит загрузчики OHLCV, автотрейдинг и воркер новостей, сохраняя модульность развёртывания.【F:doc/project_overview.md†L49-L52】【F:src/main.py†L490-L793】

## 9. Контроль качества и тесты
Регрессионные наборы покрывают индикаторы, стратегии и устойчивость автоисцеления/наблюдаемости, что создаёт защитный периметр вокруг ключевых подсистем перед релизами.【F:doc/project_overview.md†L45-L48】

