<section id="balance-container"
  class="bg-white border border-gray-200 rounded-md shadow-sm p-4"
  hx-get="/ui/partials/balance"
  hx-trigger="refresh from:body"
  hx-include="#controls"
  hx-params="mode,testnet"
  hx-indicator=".htmx-indicator"
  hx-swap="outerHTML">

  {% if bal %}
    <!-- Заголовок -->
    <h2 class="text-lg font-semibold mb-3">
      Баланс ({{ bal.exchange|upper }}{% if bal.testnet %} — TESTNET{% endif %})
    </h2>

    <!-- Equity -->
    <div class="mb-4">
      <span class="font-medium">Equity (USDT):</span>
      {% if bal.equity_usdt is not none %}
        <span class="font-semibold">{{ '%.2f'|format(bal.equity_usdt) }}</span>
      {% else %}
        {# fallback: сумма стейблов #}
        {% set stables = ['USDT','USDC','FDUSD','TUSD','BUSD','USD'] %}
        {% set total_stable = 0 %}
        {% for b in bal.balances or [] %}
          {% if b.asset in stables %}
            {% set total_stable = total_stable + (b.total or 0) %}
          {% endif %}
        {% endfor %}
        {% if total_stable > 0 %}
          <span class="font-semibold">{{ '%.2f'|format(total_stable) }}</span>
          <span class="text-xs text-gray-400">(прибл. по стейблам)</span>
        {% else %}
          — <span class="text-xs text-gray-500">нет данных</span>
        {% endif %}
      {% endif %}
    </div>

    <!-- Таблица активов -->
    {% if bal.balances %}
      {% set rows = (bal.balances | selectattr('total','gt',0) | list) %}
      {% if rows|length > 0 %}
        {% set rows_sorted = rows|sort(attribute='total', reverse=True) %}
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border border-gray-200 rounded">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left">Asset</th>
                <th class="px-3 py-2 text-right">Free</th>
                <th class="px-3 py-2 text-right">Locked</th>
                <th class="px-3 py-2 text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for b in rows_sorted %}
                <tr class="border-t">
                  <td class="px-3 py-1 font-medium">{{ b.asset }}</td>
                  <td class="px-3 py-1 text-right">{{ '%.6f'|format(b.free) }}</td>
                  <td class="px-3 py-1 text-right">{{ '%.6f'|format(b.locked) }}</td>
                  <td class="px-3 py-1 text-right font-medium">{{ '%.6f'|format(b.total) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-gray-500">Нет активов с ненулевым балансом</p>
      {% endif %}
    {% else %}
      <p class="text-gray-500">Нет активов</p>
    {% endif %}

    <!-- Риск-лимиты -->
    <div class="mt-4">
        <span class="font-medium">Equity USDT:</span>
  {{ '%.2f'|format(bal.equity_usdt or 0.0) }}
      <div class="font-medium">Лимиты риска:</div>
      <ul class="list-disc ml-5 text-sm">
        <li>Начальный equity:
          {{ '%.2f'|format(bal.risk.daily_start_equity) if bal.risk.daily_start_equity is not none else '—' }}
        </li>
        <li>Макс. убыток (%):
          {{ '%.2f'|format(bal.risk.daily_max_loss_pct * 100) if bal.risk.daily_max_loss_pct is not none else '—' }}
        </li>
        <li>Макс. сделок в день:
          {{ bal.risk.max_trades_per_day if bal.risk.max_trades_per_day is not none else '—' }}
        </li>
      </ul>
    </div>

  {% else %}
    <p class="text-gray-500">Баланс не получен</p>
  {% endif %}
</section>
