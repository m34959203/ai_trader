<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>AI-Trader Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator { display: inline-block; }

    .toast { pointer-events: auto; transform: translateY(0); transition: opacity .2s ease, transform .2s ease; }
    .toast-enter { opacity: 0; transform: translateY(6px); }
    .toast-exit  { opacity: 0; transform: translateY(-6px); }

    .tooltip {
      position: fixed; max-width: 280px; font-size: 12px; line-height: 1.35;
      padding: 8px 10px; border-radius: 6px; border: 1px solid rgba(0,0,0,.08);
      background: #111827; color: #F9FAFB; box-shadow: 0 6px 20px rgba(0,0,0,.18);
      z-index: 1000; pointer-events: none; opacity: 0; transform: translateY(4px);
      transition: opacity .12s ease, transform .12s ease;
    }
    .tooltip.show { opacity: 1; transform: translateY(0); }
    .tooltip a { color: #A5B4FC; text-decoration: underline; }
    .tip-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; border-radius: 9999px; font-size: 12px; line-height: 1;
      background: #EEF2FF; color: #3730A3; border: 1px solid #C7D2FE; user-select: none;
    }

    .error-message {
      display: none; padding: 10px; margin: 10px 0; border-radius: 6px;
      background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626;
    }
  </style>
</head>

<body class="h-full bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">AI-Trader Dashboard</h1>
      <div class="flex items-center space-x-3">
        <span class="htmx-indicator text-sm text-gray-600" aria-live="polite">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶</span>
        <button type="button" id="btnTheme"
                class="px-3 py-1.5 rounded border text-sm hover:bg-gray-100"
                title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì</button>
      </div>
    </div>

    <!-- Global Error Message -->
    <div id="global-error" class="error-message"></div>

    <!-- Controls -->
    <div id="controls" class="bg-white border border-gray-200 rounded-md p-4 mb-6 shadow-sm"
         data-tooltip="–≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–∞—Ä—Ç–∏–∞–ª–æ–≤ (balance/positions/orders/metrics).">
      <form id="ui-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end" onsubmit="return false;">
        <!-- Exec mode -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">–†–µ–∂–∏–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
            <span class="tip-icon align-middle ml-1" tabindex="0"
                  data-tooltip="binance ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ REST/WebSocket-–¥–∞–Ω–Ω—ã–µ –±–∏—Ä–∂–∏; sim ‚Äî —Å–∏–º—É–ª—è—Ç–æ—Ä –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫.">i</span>
          </span>
          <select id="mode" name="mode" class="w-full border-gray-300 rounded-md">
            <option value="binance" selected>binance</option>
            <option value="sim">sim</option>
          </select>
        </label>

        <!-- Testnet -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">Testnet
            <span class="tip-icon align-middle ml-1" tabindex="0"
                  data-tooltip="true ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É Binance (–Ω—É–∂–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ API-–∫–ª—é—á–∏). false ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç—å.">i</span>
          </span>
          <select id="testnet" name="testnet" class="w-full border-gray-300 rounded-md">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </label>

        <!-- Auto refresh -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            <span class="tip-icon align-middle ml-1" tabindex="0"
                  data-tooltip="–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫. 0 ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.">i</span>
          </span>
          <select id="refreshSec" class="w-full border-gray-300 rounded-md">
            <option value="5" selected>–∫–∞–∂–¥—ã–µ 5s</option>
            <option value="10">–∫–∞–∂–¥—ã–µ 10s</option>
            <option value="15">–∫–∞–∂–¥—ã–µ 15s</option>
            <option value="30">–∫–∞–∂–¥—ã–µ 30s</option>
            <option value="0">–≤—ã–∫–ª.</option>
          </select>
        </label>

        <!-- Buttons -->
        <div class="flex space-x-2">
          <button type="button"
                  class="px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 w-full"
                  onclick="refreshAll()"
                  title="–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–∞—Ä—Ç–∏–∞–ª—ã –∑–∞–Ω–æ–≤–æ">
            –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
          </button>
        </div>
      </form>
    </div>

    <!-- 4-column grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Balance (STABLE WRAPPER) -->
      <section id="balance-box"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4"
        hx-get="/ui/partials/balance"
        hx-trigger="load, refresh, every 5s"
        hx-include="#ui-form"
        hx-indicator=".htmx-indicator"
        hx-target="#balance"
        hx-swap="outerHTML"
        data-tooltip="–¢–µ–∫—É—â–∏–π equity –≤ USDT –∏ –ª–∏–º–∏—Ç—ã —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞.">
        <div id="balance"><div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞‚Ä¶</div></div>
      </section>

      <!-- Positions (STABLE WRAPPER) -->
      <section id="positions-box"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4"
        hx-get="/ui/partials/positions"
        hx-trigger="load, refresh, every 5s"
        hx-include="#ui-form"
        hx-indicator=".htmx-indicator"
        hx-target="#positions"
        hx-swap="outerHTML"
        data-tooltip="–°–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π.">
        <div id="positions"><div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π‚Ä¶</div></div>
      </section>

      <!-- Orders (STABLE WRAPPER) -->
      <section id="orders-box"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4 lg:col-span-1"
        hx-get="/ui/partials/orders?limit=30"
        hx-trigger="load, refresh, every 5s"
        hx-include="#ui-form"
        hx-indicator=".htmx-indicator"
        hx-target="#orders"
        hx-swap="outerHTML"
        data-tooltip="–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞ –∏–∑ –ë–î.">
        <div id="orders"><div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ä–¥–µ—Ä–æ–≤‚Ä¶</div></div>
      </section>

      <!-- Metrics (STABLE WRAPPER) -->
      <section id="metrics-box"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4 lg:col-span-1"
        hx-get="/ui/partials/metrics"
        hx-trigger="load, refresh, every 60s"
        hx-include="#ui-form"
        hx-indicator=".htmx-indicator"
        hx-target="#metrics"
        hx-swap="outerHTML"
        data-tooltip="Sharpe –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å BTCUSDT/1h.">
        <div id="metrics"><div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç—Ä–∏–∫‚Ä¶</div></div>
      </section>
    </div>

    <p class="mt-6 text-xs text-gray-500">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–∫–ª—é—á–∞–π —Ä–µ–∂–∏–º <code>binance/sim</code> –∏ —Ñ–ª–∞–≥ <code>testnet</code> ‚Äî –ø–∞—Ä—Ç–∏–∞–ª—ã –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç –¥–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
      –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—é—Ç—Å—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º ¬´–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª.
    </p>
  </div>

  <!-- Toast container -->
  <div id="toast-root" class="fixed z-50 top-4 right-4 space-y-2 pointer-events-none"></div>

  <script>
    // ------------------------ Persistence ------------------------
    const LS_KEYS = { mode:'ui.mode', testnet:'ui.testnet', refreshSec:'ui.refreshSec', theme:'ui.theme' };
    const lsGet=(k,d)=>{ try{ const v=localStorage.getItem(k); return v===null?d:v }catch{return d} }
    const lsSet=(k,v)=>{ try{ localStorage.setItem(k,v) }catch{} }
    function initControlsFromStorage(){
      document.getElementById('mode').value     = lsGet(LS_KEYS.mode, 'binance');
      document.getElementById('testnet').value  = lsGet(LS_KEYS.testnet, 'true');
      document.getElementById('refreshSec').value = lsGet(LS_KEYS.refreshSec, '5');
      applyTheme(lsGet(LS_KEYS.theme, 'light'));
    }
    function persistControls(){
      lsSet(LS_KEYS.mode,     document.getElementById('mode').value);
      lsSet(LS_KEYS.testnet,  document.getElementById('testnet').value);
      lsSet(LS_KEYS.refreshSec, document.getElementById('refreshSec').value);
    }

    // ------------------------ Theme ------------------------
    function applyTheme(mode){
      const html=document.documentElement, body=document.body, dark=(mode==='dark');
      html.classList.toggle('dark',dark);
      body.classList.toggle('bg-gray-900',dark);
      body.classList.toggle('text-gray-100',dark);
      document.querySelectorAll('section, #controls').forEach(el=>{
        el.classList.toggle('bg-gray-800',dark);
        el.classList.toggle('border-gray-700',dark);
      });
    }
    document.getElementById('btnTheme').addEventListener('click',()=>{
      const cur=lsGet(LS_KEYS.theme,'light'); const next=(cur==='dark'?'light':'dark');
      lsSet(LS_KEYS.theme,next); applyTheme(next);
    });

    // ------------------------ Intervals & refresh (work on *-box wrappers) ------------------------
    function setBoxInterval(id, sec){
      const el=document.getElementById(id); if(!el) return;
      const base='load, refresh';
      el.setAttribute('hx-trigger', sec>0 ? `${base}, every ${sec}s` : base);
    }
    function applyIntervals(){
      const sec=parseInt(document.getElementById('refreshSec').value||'5',10);
      ['balance-box','positions-box','orders-box','metrics-box'].forEach(id=>setBoxInterval(id,sec));
      persistControls();
      refreshAll();
    }
    function refreshAll(){
      ['balance-box','positions-box','orders-box','metrics-box'].forEach(id=>{
        const el=document.getElementById(id);
        if (el && window.htmx && htmx.trigger) { htmx.trigger(el,'refresh'); }
      });
    }

    // controls -> change
    ['mode','testnet','refreshSec'].forEach(id=>{
      const el=document.getElementById(id);
      if (!el) return;
      el.addEventListener('change',()=>{ (id==='refreshSec') ? applyIntervals() : (persistControls(), refreshAll()); });
    });

    // ------------------------ Tooltips ------------------------
    (function initTooltips(){
      const tip = document.createElement('div'); tip.className = 'tooltip'; document.body.appendChild(tip);
      let timerHide=null, currentTarget=null;
      const show=(el,x,y)=>{
        tip.innerHTML=(el.getAttribute('data-tooltip')||'').replace(/\n\s+/g,' ').trim();
        const rect=tip.getBoundingClientRect(), off=12, vw=innerWidth, vh=innerHeight;
        let left=x+off, top=y+off;
        if (left+rect.width+16>vw) left=vw-rect.width-16; if (top+rect.height+16>vh) top=vh-rect.height-16;
        if (left<8) left=8; if (top<8) top=8; tip.style.left=left+'px'; tip.style.top=top+'px'; tip.classList.add('show');
      };
      const hideSoon=()=>{ clearTimeout(timerHide); timerHide=setTimeout(()=>tip.classList.remove('show'),100); };
      document.body.addEventListener('mousemove', e=>{ if (currentTarget) show(currentTarget,e.clientX,e.clientY); });
      document.body.addEventListener('mouseover', e=>{ const el=e.target.closest('[data-tooltip]'); if (!el) return; currentTarget=el; show(el,e.clientX,e.clientY); });
      document.body.addEventListener('mouseout', e=>{ if (currentTarget && !e.relatedTarget?.closest('[data-tooltip]')) { currentTarget=null; hideSoon(); } });
      document.body.addEventListener('focusin', e=>{ const el=e.target.closest('[data-tooltip]'); if (!el) return; currentTarget=el; const r=el.getBoundingClientRect(); show(el,r.right,r.top); });
      document.body.addEventListener('focusout', e=>{ if (currentTarget && !e.relatedTarget?.closest('[data-tooltip]')) { currentTarget=null; hideSoon(); } });
      document.body.addEventListener('htmx:afterSwap', ()=>{ currentTarget=null; tip.classList.remove('show'); });
    })();

    // ------------------------ HTMX hooks ------------------------
    function showToast(msg, kind='error'){
      const root=document.getElementById('toast-root'); if (!root) return;
      const div=document.createElement('div');
      div.className='toast toast-enter max-w-sm w-80 px-3 py-2 rounded shadow border '+
        (kind==='error'?'bg-red-50 border-red-200 text-red-800':'bg-emerald-50 border-emerald-200 text-emerald-800');
      div.innerHTML=`<div class="text-sm">${String(msg)}</div>`; root.appendChild(div);
      requestAnimationFrame(()=>div.classList.remove('toast-enter'));
      setTimeout(()=>{ div.classList.add('toast-exit'); setTimeout(()=>div.remove(),180); },3000);
    }
    const showGlobalError=(m)=>{ const e=document.getElementById('global-error'); if(!e) return; e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',5000); };

    document.addEventListener('htmx:responseError', e=>{
      const status = e.detail.xhr ? e.detail.xhr.status : '???';
      showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${status}). –ü—Ä–æ–≤–µ—Ä—å API/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã.`,'error'); showGlobalError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${status}).`);
    });
    document.addEventListener('htmx:sendError', ()=>{ showToast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (sendError).','error'); showGlobalError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.'); });
    document.addEventListener('htmx:timeout',   ()=> showToast('–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞.','error'));
    document.addEventListener('htmx:swapError', ()=> showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.','error'));
    document.addEventListener('htmx:afterSwap', ()=>{ applyTheme(lsGet(LS_KEYS.theme,'light')); });

    window.addEventListener('offline', ()=>{ showToast('–í—ã –æ—Ñ–ª–∞–π–Ω.','error'); showGlobalError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'); });
    window.addEventListener('online',  ()=> showToast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.','ok'));

    // boot
    document.addEventListener('DOMContentLoaded', ()=>{ initControlsFromStorage(); applyIntervals(); });
  </script>

  <noscript>
    <div class="max-w-3xl mx-auto mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
      –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è JavaScript (HTMX).
    </div>
  </noscript>
</body>
</html>
