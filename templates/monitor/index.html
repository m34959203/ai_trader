<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>AI-Trader Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- HTMX (–æ–±–Ω–æ–≤–ª–µ–Ω–æ) -->
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

  <!-- Tailwind (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />

  <style>
    /* HTMX inline indicator */
    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator { display: inline-block; }

    /* Toasts */
    .toast {
      pointer-events: auto;
      transform: translateY(0);
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast-enter { opacity: 0; transform: translateY(6px); }
    .toast-exit  { opacity: 0; transform: translateY(-6px); }
  </style>
</head>

<body class="h-full bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">AI-Trader Dashboard</h1>

      <div class="flex items-center space-x-3">
        <!-- Live indicator -->
        <span class="htmx-indicator text-sm text-gray-600" aria-live="polite">
          –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶
        </span>

        <!-- Dark mode toggle -->
        <button
          type="button"
          id="btnTheme"
          class="px-3 py-1.5 rounded border text-sm hover:bg-gray-100"
          title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
          aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
        >üåì</button>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls" class="bg-white border border-gray-200 rounded-md p-4 mb-6 shadow-sm">
      <form class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end" onsubmit="return false;">
        <!-- Exec mode -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">–†–µ–∂–∏–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</span>
          <select id="mode" name="mode" class="w-full border-gray-300 rounded-md">
            <option value="binance">binance</option>
            <option value="sim">sim</option>
          </select>
        </label>

        <!-- Testnet -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">Testnet</span>
          <select id="testnet" name="testnet" class="w-full border-gray-300 rounded-md">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </label>

        <!-- Auto refresh -->
        <label class="block">
          <span class="block text-sm font-medium mb-1">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
          <select id="refreshSec" class="w-full border-gray-300 rounded-md">
            <option value="5">–∫–∞–∂–¥—ã–µ 5s</option>
            <option value="10">–∫–∞–∂–¥—ã–µ 10s</option>
            <option value="15">–∫–∞–∂–¥—ã–µ 15s</option>
            <option value="30">–∫–∞–∂–¥—ã–µ 30s</option>
            <option value="0">–≤—ã–∫–ª.</option>
          </select>
        </label>

        <!-- Buttons -->
        <div class="flex space-x-2">
          <button
            type="button"
            class="px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 w-full"
            onclick="refreshAll()"
            title="–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–∞—Ä—Ç–∏–∞–ª—ã –∑–∞–Ω–æ–≤–æ"
          >
            –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å
          </button>
        </div>
      </form>
    </div>

    <!-- 4-column grid (Balance / Positions / Orders / Metrics) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Balance -->
      <section
        id="balance"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4"
        hx-get="/ui/partials/balance"
        hx-trigger="load, refresh from:body"
        hx-include="#controls"
        hx-params="mode,testnet"
        hx-indicator=".htmx-indicator"
        hx-swap="outerHTML"
      >
        <div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞‚Ä¶</div>
      </section>

      <!-- Positions -->
      <section
        id="positions"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4"
        hx-get="/ui/partials/positions"
        hx-trigger="load, refresh from:body"
        hx-include="#controls"
        hx-params="mode,testnet"
        hx-indicator=".htmx-indicator"
        hx-swap="outerHTML"
      >
        <div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π‚Ä¶</div>
      </section>

      <!-- Orders -->
      <section
        id="orders"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4 lg:col-span-1"
        hx-get="/ui/partials/orders"
        hx-trigger="load, refresh from:body"
        hx-include="#controls"
        hx-params="mode,testnet"
        hx-indicator=".htmx-indicator"
        hx-swap="outerHTML"
      >
        <div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ä–¥–µ—Ä–æ–≤‚Ä¶</div>
      </section>

      <!-- Metrics -->
      <section
        id="metrics"
        class="bg-white border border-gray-200 rounded-md shadow-sm p-4 lg:col-span-1"
        hx-get="/ui/partials/metrics"
        hx-trigger="load, refresh from:body"
        hx-include="#controls"
        hx-params="mode,testnet"
        hx-indicator=".htmx-indicator"
        hx-swap="outerHTML"
      >
        <div class="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç—Ä–∏–∫‚Ä¶</div>
      </section>
    </div>

    <p class="mt-6 text-xs text-gray-500">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–∫–ª—é—á–∞–π —Ä–µ–∂–∏–º <code>binance/sim</code> –∏ —Ñ–ª–∞–≥ <code>testnet</code> ‚Äî –ø–∞—Ä—Ç–∏–∞–ª—ã –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç –¥–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
      –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—é—Ç—Å—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º ¬´–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª.
    </p>
  </div>

  <!-- Toast container -->
  <div id="toast-root" class="fixed z-50 top-4 right-4 space-y-2 pointer-events-none"></div>

  <script>
    // ------------------------
    // Persistence (localStorage)
    // ------------------------
    const LS_KEYS = {
      mode: 'ui.mode',
      testnet: 'ui.testnet',
      refreshSec: 'ui.refreshSec',
      theme: 'ui.theme', // 'light' | 'dark'
    };

    function lsGet(k, def) { try { const v = localStorage.getItem(k); return v === null ? def : v; } catch { return def; } }
    function lsSet(k, v) { try { localStorage.setItem(k, v); } catch {} }

    function initControlsFromStorage() {
      document.getElementById('mode').value = lsGet(LS_KEYS.mode, 'binance');
      document.getElementById('testnet').value = lsGet(LS_KEYS.testnet, 'true');
      document.getElementById('refreshSec').value = lsGet(LS_KEYS.refreshSec, '10');

      // theme
      const theme = lsGet(LS_KEYS.theme, 'light');
      applyTheme(theme);
    }

    function persistControls() {
      lsSet(LS_KEYS.mode, document.getElementById('mode').value);
      lsSet(LS_KEYS.testnet, document.getElementById('testnet').value);
      lsSet(LS_KEYS.refreshSec, document.getElementById('refreshSec').value);
    }

    // ------------------------
    // Theme
    // ------------------------
    function applyTheme(mode) {
      const html = document.documentElement;
      const body = document.body;
      const dark = (mode === 'dark');
      html.classList.toggle('dark', dark);
      body.classList.toggle('bg-gray-900', dark);
      body.classList.toggle('text-gray-100', dark);

      // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Å–µ–∫—Ü–∏–π (–≤–∫–ª—é—á–∞—è –ø–æ–¥–º–µ–Ω—ë–Ω–Ω—ã–µ HTMX)
      document.querySelectorAll('section, #controls').forEach(el => {
        el.classList.toggle('bg-gray-800', dark);
        el.classList.toggle('border-gray-700', dark);
      });
    }

    document.getElementById('btnTheme').addEventListener('click', () => {
      const cur = lsGet(LS_KEYS.theme, 'light');
      const next = cur === 'dark' ? 'light' : 'dark';
      lsSet(LS_KEYS.theme, next);
      applyTheme(next);
    });

    // ------------------------
    // HTMX helpers
    // ------------------------
    function setSectionInterval(id, sec) {
      const el = document.getElementById(id);
      if (!el) return;
      // –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å custom-—Ç—Ä–∏–≥–≥–µ—Ä 'refresh from:body'
      const base = 'load, refresh from:body';
      el.setAttribute('hx-trigger', sec > 0 ? `${base}, every ${sec}s` : base);
    }

    function applyIntervals() {
      const sec = parseInt(document.getElementById('refreshSec').value || '10', 10);
      ['balance','positions','orders','metrics'].forEach(id => setSectionInterval(id, sec));
      persistControls();
      refreshAll();
    }

    // –ö–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å: —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ body ‚Üí –≤—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–∞–º–∏ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å—è—Ç—Å—è
    function refreshAll() {
      htmx.trigger(document.body, 'refresh');
    }

    // Persist + actions on changes
    ['mode','testnet','refreshSec'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', () => {
        persistControls();
        if (id === 'refreshSec') applyIntervals();
        else refreshAll();
      });
    });

    // ------------------------
    // Toasts
    // ------------------------
    function showToast(msg, kind='error') {
      const root = document.getElementById('toast-root');
      const div = document.createElement('div');
      div.className =
        'toast toast-enter max-w-sm w-80 px-3 py-2 rounded shadow border ' +
        (kind === 'error'
          ? 'bg-red-50 border-red-200 text-red-800'
          : 'bg-emerald-50 border-emerald-200 text-emerald-800');

      div.innerHTML = `<div class="text-sm">${escapeHtml(msg)}</div>`;
      root.appendChild(div);

      requestAnimationFrame(() => div.classList.remove('toast-enter')); // animate in
      setTimeout(() => { // auto close
        div.classList.add('toast-exit');
        setTimeout(() => div.remove(), 180);
      }, 3000);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
      }[m]));
    }

    // ------------------------
    // HTMX error & post-swap hooks
    // ------------------------
    document.body.addEventListener('htmx:responseError', (e) => {
      const status = e.detail.xhr ? e.detail.xhr.status : '???';
      showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${status}). –ü—Ä–æ–≤–µ—Ä—å API/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã.`, 'error');
    });
    document.body.addEventListener('htmx:sendError', () => {
      showToast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (sendError).', 'error');
    });
    document.body.addEventListener('htmx:timeout', () => {
      showToast('–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞.', 'error');
    });

    // –ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ swap ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –∫ –Ω–æ–≤–æ–º—É DOM
    document.body.addEventListener('htmx:afterSwap', () => {
      const theme = lsGet(LS_KEYS.theme, 'light');
      applyTheme(theme);
    });

    // Online/offline hints
    window.addEventListener('offline', () => showToast('–í—ã –æ—Ñ–ª–∞–π–Ω.', 'error'));
    window.addEventListener('online',  () => showToast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.', 'ok'));

    // ------------------------
    // Boot
    // ------------------------
    document.addEventListener('DOMContentLoaded', () => {
      initControlsFromStorage();
      applyIntervals(); // sets triggers + kicks first refresh
    });
  </script>

  <noscript>
    <div class="max-w-3xl mx-auto mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
      –î–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞–Ω–µ–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è JavaScript (HTMX).
    </div>
  </noscript>
</body>
</html>
