<div id="limits" class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Риск-лимиты и стратегии</h2>
    <button type="button" class="text-xs px-3 py-1 border border-indigo-500 text-indigo-600 rounded hover:bg-indigo-50" onclick="generateReports()">Пересоздать отчёты</button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Лимит на сделку</div>
      <div class="font-medium">{{ (limits.risk_config.per_trade_cap * 100)|round(2) if limits.risk_config.per_trade_cap is not none else '—' }}%</div>
    </div>
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Дневной стоп</div>
      <div class="font-medium">{{ (limits.risk_config.daily_max_loss_pct * 100)|round(2) if limits.risk_config.daily_max_loss_pct is not none else '—' }}%</div>
    </div>
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Лимит сделок/день</div>
      <div class="font-medium">{{ limits.risk_config.max_trades_per_day if limits.risk_config.max_trades_per_day is not none else '—' }}</div>
    </div>
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Старт equity</div>
      <div class="font-medium">{{ limits.daily.start_equity if limits.daily.start_equity is not none else '—' }}</div>
    </div>
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Текущее equity</div>
      <div class="font-medium">{{ limits.daily.current_equity if limits.daily.current_equity is not none else '—' }}</div>
    </div>
    <div class="bg-gray-50 border border-gray-200 rounded-md p-3">
      <div class="text-gray-500">Реализованный PnL</div>
      {% if limits.daily.realized_pnl is not none %}
        {% set cls = 'text-emerald-600' if limits.daily.realized_pnl > 0 else ('text-rose-600' if limits.daily.realized_pnl < 0 else 'text-gray-900') %}
        <div class="font-medium {{ cls }}">{{ limits.daily.realized_pnl }}</div>
      {% else %}
        <div class="text-gray-500">—</div>
      {% endif %}
    </div>
  </div>

  <div>
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Стратегии</h3>
    {% if limits.strategies %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs border border-gray-200 rounded">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="px-2 py-1 text-left">Название</th>
              <th class="px-2 py-1 text-center">Вкл.</th>
              <th class="px-2 py-1 text-right">Макс. риск</th>
              <th class="px-2 py-1 text-right">Макс. сделок</th>
              <th class="px-2 py-1 text-right">Использовано</th>
              <th class="px-2 py-1 text-left">Обновлено</th>
              <th class="px-2 py-1 text-left"></th>
            </tr>
          </thead>
          <tbody>
            {% for strat in limits.strategies %}
              <tr class="border-t" data-strategy="{{ strat.name }}">
                <td class="px-2 py-1 font-medium">{{ strat.name }}</td>
                <td class="px-2 py-1 text-center">
                  <input type="checkbox" data-field="enabled" {% if strat.enabled %}checked{% endif %} onchange="toggleStrategy('{{ strat.name }}', this)" />
                </td>
                <td class="px-2 py-1 text-right">
                  <input type="number" step="0.001" data-field="risk" value="{{ strat.max_risk_fraction if strat.max_risk_fraction is not none else '' }}" class="w-20 border border-gray-300 rounded px-1 py-0.5 text-right" placeholder="0.02" />
                </td>
                <td class="px-2 py-1 text-right">
                  <input type="number" min="0" data-field="max-trades" value="{{ strat.max_daily_trades if strat.max_daily_trades is not none else '' }}" class="w-20 border border-gray-300 rounded px-1 py-0.5 text-right" placeholder="10" />
                </td>
                <td class="px-2 py-1 text-right">{{ strat.trades_today }}</td>
                <td class="px-2 py-1 text-left text-gray-500">{{ strat.updated_at }}</td>
                <td class="px-2 py-1 text-left">
                  <button type="button" class="px-2 py-1 text-xs border border-indigo-500 text-indigo-600 rounded hover:bg-indigo-50" onclick="submitStrategy('{{ strat.name }}')">Сохранить</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-sm text-gray-500">Стратегии не настроены.</div>
    {% endif %}
  </div>

  <div class="space-y-2">
    <h3 class="text-sm font-semibold text-gray-700">Отчёты</h3>
    {% set csv = reports.get('csv') if reports else None %}
    {% set pdf = reports.get('pdf') if reports else None %}
    <div class="text-xs text-gray-500">Последняя генерация: {{ reports.generated_at if reports and reports.generated_at is defined else '—' }}</div>
    <div class="flex flex-wrap items-center gap-3 text-xs">
      <a href="/reports/download/csv" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 {{ 'text-indigo-600' if csv else 'text-gray-400 pointer-events-none' }}">CSV</a>
      <a href="/reports/download/pdf" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 {{ 'text-indigo-600' if pdf else 'text-gray-400 pointer-events-none' }}">PDF</a>
      {% if csv and csv.size is not none %}
        <span class="text-gray-500">CSV: {{ (csv.size/1024)|round(1) }} КБ</span>
      {% endif %}
      {% if pdf and pdf.size is not none %}
        <span class="text-gray-500">PDF: {{ (pdf.size/1024)|round(1) }} КБ</span>
      {% endif %}
    </div>
  </div>
</div>
