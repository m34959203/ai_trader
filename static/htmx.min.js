/* static/htmx.min.js
 * Lightweight HTMX loader shim.
 * - If window.htmx is already present, does nothing.
 * - Otherwise loads HTMX from CDN (configurable via window.HTMX_CDN).
 * - Emits 'htmx:shim-loaded' after successful injection (before htmx loads),
 *   and 'htmx:shim-failed' on error.
 */
(function (w, d) {
  try {
    if (w.htmx) return; // already present (e.g., bundled elsewhere)

    // You can override CDN URL before this file runs:
    //   <script>window.HTMX_CDN="https://unpkg.com/htmx.org@1.9.12";</script>
    var cdn = String(w.HTMX_CDN || "https://unpkg.com/htmx.org@1.9.12").trim();

    var s = d.createElement("script");
    s.src = cdn;
    s.defer = true;

    s.onload = function () {
      // HTMX itself fires 'htmx:load' on fragments; here we just announce shim worked.
      try {
        d.dispatchEvent(new CustomEvent("htmx:shim-loaded", { detail: { cdn: cdn } }));
      } catch (e) {}
    };

    s.onerror = function () {
      try {
        d.dispatchEvent(new CustomEvent("htmx:shim-failed", { detail: { cdn: cdn } }));
      } catch (e) {}
      // Minimal visible hint in dev to avoid confusing blank UI
      try {
        var box = d.createElement("div");
        box.style.cssText =
          "position:fixed;bottom:12px;left:12px;z-index:99999;padding:10px 12px;" +
          "background:#FEE2E2;color:#7F1D1D;border:1px solid #FCA5A5;border-radius:6px;" +
          "font:12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
        box.textContent = "HTMX: не удалось загрузить " + cdn + ". Проверь подключение/URL.";
        d.body.appendChild(box);
        setTimeout(function(){ if (box && box.parentNode) box.parentNode.removeChild(box); }, 6000);
      } catch (_) {}
      // No throw: keep app running even without HTMX
      console.error("[HTMX shim] Failed to load from CDN:", cdn);
    };

    d.head.appendChild(s);
  } catch (err) {
    console.error("[HTMX shim] Unexpected error:", err);
  }
})(window, document);
